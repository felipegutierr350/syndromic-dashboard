<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syndromic Trends Dashboard - Secretaría de Salud Bogotá</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .header {
            background: #ffffff;
            border-bottom: 3px solid #0066cc;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: #0066cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
        }

        h1 {
            font-size: 28px;
            color: #0066cc;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .subtitle {
            font-size: 14px;
            color: #6c757d;
            margin-top: 4px;
        }

        .update-info {
            text-align: right;
            font-size: 14px;
            color: #6c757d;
        }

        .update-time {
            font-weight: 600;
            color: #2c3e50;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .alert-banner {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-banner.critical {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-icon {
            font-size: 24px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-chart {
            grid-column: span 2;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        
        .main-chart .chart-container {
            height: 450px; /* Más alto para el gráfico principal */
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #0066cc;
            line-height: 1;
        }

        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 8px;
        }

        .pathogen-list {
            list-style: none;
            margin-top: 16px;
        }

        .pathogen-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #0066cc;
            transition: all 0.2s ease;
        }

        .pathogen-item:hover {
            background: #e9ecef;
            transform: translateX(4px);
        }

        .pathogen-item.high-risk {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .pathogen-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .pathogen-percentage {
            font-size: 20px;
            font-weight: 700;
            color: #0066cc;
        }

        .pathogen-item.high-risk .pathogen-percentage {
            color: #dc3545;
        }

        .trend-indicator {
            font-size: 14px;
            margin-left: 8px;
        }

        .trend-up {
            color: #dc3545;
        }

        .trend-down {
            color: #28a745;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            background: #2c3e50;
            color: #ffffff;
            padding: 20px 0;
            margin-top: 40px;
            text-align: center;
            font-size: 14px;
        }

        .chart-summary {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            color: #6c757d;
            border: 1px solid #e9ecef;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .main-chart {
                grid-column: span 1;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header-content {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
            
            .update-info {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">ST</div>
                <div>
                    <h1>Syndromic Trends Dashboard</h1>
                    <div class="subtitle">Sistema de Vigilancia Epidemiológica - Secretaría de Salud de Bogotá</div>
                </div>
            </div>
            <div class="update-info">
                <div>Última actualización</div>
                <div class="update-time" id="lastUpdate">--:--</div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="alert-banner" id="alertBanner" style="display: none;">
            <span class="alert-icon">⚠️</span>
            <div id="alertMessage"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalWeeks">--</div>
                <div class="stat-label">Semanas Analizadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalPathogens">--</div>
                <div class="stat-label">Patógenos Detectados</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgPositivity">--%</div>
                <div class="stat-label">Positividad Promedio</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="maxPositivity">--%</div>
                <div class="stat-label">Positividad Máxima</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="card main-chart">
                <h2 class="card-title">
                    📊 Barras Apiladas - Evolución de Patógenos 2025 (% Positividad)
                </h2>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">
                    🦠 Top 10 Patógenos - Última Semana
                </h2>
                <div id="pathogenList" class="pathogen-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando datos...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">
                    📈 Tendencia Temporal 2025 - Rhinovirus/Enterovirus
                </h2>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>Secretaría de Salud de Bogotá © 2025 - Sistema de Vigilancia Syndromic Trends</p>
    </footer>

    <!-- Cargar Chart.js con múltiples opciones de CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Fallback si el primer CDN falla
        if (typeof Chart === 'undefined') {
            console.log('Intentando CDN alternativo...');
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"><\/script>');
        }
    </script>
    
    <script>
        // Configuración de la API
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzoUUg5cJ-psIJsRUKXUTvLkMWQgP__7mMOKvRnT3WknrpxPqvjZ86w_iRqHMtwtCRm/exec';
        
        console.log('Dashboard Syndromic Trends iniciando...');
        
        // Variables globales
        let data = [];
        let mainChart, trendChart;

        // Fetch data from Google Apps Script
        async function fetchData() {
            try {
                console.log('Iniciando carga de datos...');
                console.log('URL:', WEB_APP_URL.substring(0, 50) + '...');
                
                const response = await fetch(WEB_APP_URL, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Respuesta recibida:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('Respuesta cruda (primeros 100 caracteres):', text.substring(0, 100) + '...');
                
                let result;
                try {
                    result = JSON.parse(text);
                } catch (parseError) {
                    console.error('Error al parsear JSON:', parseError);
                    console.error('Texto recibido:', text);
                    throw new Error('La respuesta no es JSON válido');
                }
                
                if (result.exito && result.datos && Array.isArray(result.datos) && result.datos.length > 0) {
                    // Eliminar duplicados basándose en la fecha
                    const uniqueDates = new Map();
                    result.datos.forEach(week => {
                        if (week && week.fecha) {
                            const dateStr = new Date(week.fecha).toISOString().split('T')[0];
                            if (!uniqueDates.has(dateStr)) {
                                uniqueDates.set(dateStr, week);
                            }
                        }
                    });
                    
                    data = Array.from(uniqueDates.values()).sort((a, b) => 
                        new Date(a.fecha) - new Date(b.fecha)
                    );
                    
                    console.log(`Datos cargados: ${result.totalSemanas} total, ${data.length} únicas`);
                    
                    document.getElementById('totalWeeks').textContent = data.length;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('es-CO');
                    
                    processData();
                    
                    // Intentar crear gráficos solo si Chart.js está disponible
                    if (typeof Chart !== 'undefined') {
                        try {
                            createMainChart();
                        } catch (error) {
                            console.error('Error al crear gráfico principal:', error);
                            showAlternativeChart('mainChart', 'Error al crear el gráfico principal');
                        }
                        
                        try {
                            createTrendChart();
                        } catch (error) {
                            console.error('Error al crear gráfico de tendencias:', error);
                            showAlternativeChart('trendChart', 'Error al crear el gráfico de tendencias');
                        }
                    } else {
                        console.warn('Chart.js no disponible, mostrando datos sin gráficos');
                        showAlternativeChart('mainChart', 'Los gráficos no están disponibles. Consulte la tabla de patógenos para ver los datos.');
                        showAlternativeChart('trendChart', 'Gráfico de tendencias no disponible');
                    }
                    
                    try {
                        updatePathogenList();
                    } catch (error) {
                        console.error('Error al actualizar lista de patógenos:', error);
                    }
                } else {
                    console.error('Respuesta sin datos válidos:', result);
                    showError('No se encontraron datos válidos');
                }
            } catch (error) {
                console.error('Error detallado:', error);
                
                // Intentar diagnóstico adicional
                if (error.message.includes('Failed to fetch') || error.message.includes('Load failed')) {
                    showError('Error de conexión. Verifica que el Web App esté configurado como "Cualquier persona"');
                    console.error('Posibles causas:');
                    console.error('1. El Web App no está configurado como público');
                    console.error('2. La URL es incorrecta');
                    console.error('3. Problemas de CORS');
                    
                    // Mostrar botón para probar la URL directamente
                    const alertBanner = document.getElementById('alertBanner');
                    if (alertBanner) {
                        alertBanner.innerHTML += `
                            <div style="margin-top: 10px;">
                                <a href="${WEB_APP_URL}" target="_blank" style="color: #0066cc; text-decoration: underline;">
                                    Probar URL del Web App directamente
                                </a>
                            </div>
                        `;
                    }
                } else {
                    showError('Error: ' + error.message);
                }
            }
        }

        function processData() {
            if (!data || data.length === 0) {
                console.warn('No hay datos para procesar');
                return;
            }
            
            // Count unique pathogens
            const uniquePathogens = new Set();
            let totalPositivity = 0;
            let maxPositivity = 0;
            let count = 0;
            
            data.forEach(week => {
                if (week && week.patogenos && Array.isArray(week.patogenos)) {
                    week.patogenos.forEach(p => {
                        if (p && p.nombre) {
                            uniquePathogens.add(p.nombre);
                            if (p.posicion === 1 && typeof p.porcentaje === 'number') {
                                totalPositivity += p.porcentaje;
                                maxPositivity = Math.max(maxPositivity, p.porcentaje);
                                count++;
                            }
                        }
                    });
                }
            });
            
            document.getElementById('totalPathogens').textContent = uniquePathogens.size;
            document.getElementById('avgPositivity').textContent = count > 0 ? Math.round(totalPositivity / count) + '%' : '0%';
            document.getElementById('maxPositivity').textContent = Math.round(maxPositivity) + '%';
            
            // Check for alerts
            if (data.length > 0) {
                const latestWeek = data[data.length - 1];
                if (latestWeek && latestWeek.patogenos && latestWeek.patogenos.length > 0) {
                    const maxLatest = Math.max(...latestWeek.patogenos.map(p => p.porcentaje || 0));
                    
                    if (maxLatest > 35) {
                        const alertBanner = document.getElementById('alertBanner');
                        const alertMessage = document.getElementById('alertMessage');
                        alertBanner.style.display = 'flex';
                        alertBanner.className = 'alert-banner critical';
                        alertMessage.innerHTML = `<strong>ALERTA CRÍTICA:</strong> ${latestWeek.patogenos[0].nombre || 'Patógeno desconocido'} ha alcanzado ${maxLatest.toFixed(1)}% de positividad`;
                    }
                }
            }
        }

        function createMainChart() {
            if (!data || data.length === 0) {
                console.warn('No hay datos para crear el gráfico principal');
                return;
            }
            
            const canvas = document.getElementById('mainChart');
            if (!canvas) {
                console.error('No se encontró el canvas mainChart');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Filtrar TODAS las semanas del 2025
            let data2025 = data.filter(week => {
                try {
                    if (week && week.fecha) {
                        const date = new Date(week.fecha);
                        return !isNaN(date.getTime()) && date.getFullYear() === 2025;
                    }
                } catch (e) {
                    console.warn('Error al procesar fecha:', week.fecha);
                }
                return false;
            });
            
            // Si no hay datos del 2025, usar las últimas 52 semanas
            if (data2025.length === 0) {
                console.warn('No hay datos del 2025, mostrando últimas 52 semanas');
                data2025 = data.slice(-52);
            }
            
            if (data2025.length === 0) {
                console.error('No hay datos suficientes para crear el gráfico');
                return;
            }
            
            console.log(`Mostrando ${data2025.length} semanas únicas del 2025`);
            
            // Obtener todos los patógenos únicos del período
            const allPathogens = new Set();
            data2025.forEach(week => {
                if (week.patogenos) {
                    week.patogenos.forEach(p => {
                        if (p && p.nombre) allPathogens.add(p.nombre);
                    });
                }
            });
            
            // Convertir a array y tomar los top 7 más frecuentes
            const pathogenCounts = {};
            data2025.forEach(week => {
                if (week.patogenos) {
                    week.patogenos.forEach(p => {
                        if (p && p.nombre) {
                            pathogenCounts[p.nombre] = (pathogenCounts[p.nombre] || 0) + p.porcentaje;
                        }
                    });
                }
            });
            
            const top7Pathogens = Object.entries(pathogenCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 7)
                .map(entry => entry[0]);
            
            // Colores vibrantes y bien diferenciados para barras apiladas
            const colors = [
                { bg: '#0066cc', border: '#0052a3' },     // Azul fuerte
                { bg: '#28a745', border: '#208637' },     // Verde
                { bg: '#ffc107', border: '#d39e00' },     // Amarillo
                { bg: '#dc3545', border: '#bd2130' },     // Rojo
                { bg: '#6c757d', border: '#545b62' },     // Gris
                { bg: '#ff6f00', border: '#cc5a00' },     // Naranja
                { bg: '#9c27b0', border: '#7b1fa2' }      // Púrpura
            ];
            
            // Preparar datasets para líneas apiladas
            const datasets = top7Pathogens.map((pathogenName, index) => {
                const pathogenData = data2025.map(week => {
                    if (week && week.patogenos) {
                        const found = week.patogenos.find(p => p && p.nombre === pathogenName);
                        return found && typeof found.porcentaje === 'number' ? found.porcentaje : 0;
                    }
                    return 0;
                });
                
                return {
                    label: pathogenName,
                    data: pathogenData,
                    backgroundColor: colors[index % colors.length].bg,
                    borderColor: colors[index % colors.length].border,
                    borderWidth: 1,
                    barPercentage: 1.0,
                    categoryPercentage: 1.0
                };
            });
            
            if (mainChart) mainChart.destroy();
            
            if (typeof Chart === 'undefined') {
                console.error('Chart.js no está cargado');
                showAlternativeChart('mainChart', 'No se pudieron cargar los gráficos.');
                return;
            }
            
            // Crear gráfico de BARRAS APILADAS
            mainChart = new Chart(ctx, {
                type: 'bar', // BARRAS, NO LÍNEAS!
                data: {
                    labels: data2025.map((w, i) => {
                        try {
                            const date = new Date(w.fecha);
                            if (!isNaN(date.getTime())) {
                                // Si hay muchas semanas, mostrar solo algunas etiquetas
                                if (data2025.length > 20 && i % Math.ceil(data2025.length / 10) !== 0) {
                                    return '';
                                }
                                return date.toLocaleDateString('es-CO', { day: 'numeric', month: 'short' });
                            }
                        } catch (e) {
                            console.warn('Fecha inválida:', w.fecha);
                        }
                        return `Sem ${i + 1}`;
                    }),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Distribución de Patógenos - ${data2025.length} Semanas (Enero-Abril 2025)`,
                            font: {
                                size: 16
                            },
                            padding: 20
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 11
                                },
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                },
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        sum += tooltipItem.parsed.y;
                                    });
                                    return 'Total: ' + sum.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    // Configuración para barras más compactas
                    barPercentage: data2025.length > 20 ? 1.0 : 0.8,
                    categoryPercentage: data2025.length > 20 ? 1.0 : 0.9,
                    scales: {
                        x: {
                            stacked: true, // IMPORTANTE: apilar en X
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 15, // Máximo 15 etiquetas
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            stacked: true, // IMPORTANTE: apilar en Y
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                stepSize: 20
                            },
                            grid: {
                                color: '#e9ecef'
                            },
                            title: {
                                display: true,
                                text: 'Porcentaje de Positividad (%)',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
            
            // Agregar resumen debajo del gráfico
            const chartContainer = canvas.parentElement;
            const existingSummary = chartContainer.querySelector('.chart-summary');
            if (existingSummary) {
                existingSummary.remove();
            }
            
            // Resumen del período
            const summary = document.createElement('div');
            summary.className = 'chart-summary';
            summary.style.cssText = 'margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px;';
            summary.innerHTML = `
                <strong>Resumen del período:</strong> ${data2025.length} semanas analizadas (sin duplicados) • 
                <strong>Patógeno dominante:</strong> ${top7Pathogens[0]} • 
                <strong>Rango de fechas:</strong> ${new Date(data2025[0].fecha).toLocaleDateString('es-CO')} - ${new Date(data2025[data2025.length - 1].fecha).toLocaleDateString('es-CO')}
            `;
            chartContainer.appendChild(summary);
        }

        function createTrendChart() {
            if (!data || data.length === 0) {
                console.warn('No hay datos para crear el gráfico de tendencias');
                return;
            }
            
            const canvas = document.getElementById('trendChart');
            if (!canvas) {
                console.error('No se encontró el canvas trendChart');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Obtener datos del 2025 o últimas 52 semanas
            let trendData = data.filter(week => {
                try {
                    if (week && week.fecha) {
                        const date = new Date(week.fecha);
                        return !isNaN(date.getTime()) && date.getFullYear() === 2025;
                    }
                } catch (e) {
                    return false;
                }
                return false;
            });
            
            if (trendData.length === 0) {
                trendData = data.slice(-52);
            }
            
            // Get Rhinovirus data
            const rhinoData = trendData.map(week => {
                if (week && week.patogenos) {
                    const rhino = week.patogenos.find(p => p && p.nombre && p.nombre.includes('Rhinovirus'));
                    return rhino && typeof rhino.porcentaje === 'number' ? rhino.porcentaje : 0;
                }
                return 0;
            });
            
            // Calcular promedio móvil de 4 semanas
            const movingAverage = [];
            for (let i = 0; i < rhinoData.length; i++) {
                if (i < 3) {
                    movingAverage.push(rhinoData[i]);
                } else {
                    const avg = (rhinoData[i] + rhinoData[i-1] + rhinoData[i-2] + rhinoData[i-3]) / 4;
                    movingAverage.push(avg);
                }
            }
            
            if (rhinoData.length === 0 || rhinoData.every(v => v === 0)) {
                console.warn('No hay datos de Rhinovirus para graficar');
                return;
            }
            
            if (trendChart) trendChart.destroy();
            
            if (typeof Chart === 'undefined') {
                console.error('Chart.js no está cargado');
                showAlternativeChart('trendChart', 'Gráfico de tendencias no disponible');
                return;
            }
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.map((w, i) => {
                        try {
                            const date = new Date(w.fecha);
                            if (!isNaN(date.getTime())) {
                                if (trendData.length > 20) {
                                    return (i % 4 === 0) ? date.toLocaleDateString('es-CO', { month: 'short' }) : '';
                                } else {
                                    return date.toLocaleDateString('es-CO', { month: 'short', day: 'numeric' });
                                }
                            }
                        } catch (e) {
                            return `S${i + 1}`;
                        }
                        return `S${i + 1}`;
                    }),
                    datasets: [{
                        label: 'Human Rhinovirus/Enterovirus',
                        data: rhinoData,
                        borderColor: '#0066cc',
                        backgroundColor: 'rgba(0, 102, 204, 0.1)',
                        borderWidth: 2,
                        pointRadius: trendData.length > 20 ? 0 : 3,
                        pointBackgroundColor: '#0066cc',
                        tension: 0.1,
                        fill: true
                    }, {
                        label: 'Promedio Móvil (4 sem)',
                        data: movingAverage,
                        borderColor: '#dc3545',
                        backgroundColor: 'transparent',
                        borderWidth: 3,
                        pointRadius: 0,
                        borderDash: [5, 5],
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `${trendData.length} semanas de evolución`,
                            font: {
                                size: 12
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: Math.max(...rhinoData) * 1.2,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: '#e9ecef'
                            }
                        }
                    }
                }
            });
        }

        function updatePathogenList() {
            if (data.length === 0) return;
            
            const latestWeek = data[data.length - 1];
            if (!latestWeek || !latestWeek.patogenos) {
                document.getElementById('pathogenList').innerHTML = '<p class="loading">No hay datos disponibles</p>';
                return;
            }
            
            const listHTML = latestWeek.patogenos
                .filter(p => p && p.nombre && typeof p.porcentaje === 'number')
                .map((pathogen, index) => {
                const isHighRisk = typeof pathogen.porcentaje === 'number' && pathogen.porcentaje > 30;
                let trend = '';
                
                if (data.length > 1) {
                    const prevWeek = data[data.length - 2];
                    if (prevWeek && prevWeek.patogenos) {
                        const prevPathogen = prevWeek.patogenos.find(p => p && p.nombre === pathogen.nombre);
                        if (prevPathogen && typeof prevPathogen.porcentaje === 'number' && typeof pathogen.porcentaje === 'number') {
                            const diff = pathogen.porcentaje - prevPathogen.porcentaje;
                            if (diff > 1) {
                                trend = '<span class="trend-indicator trend-up">↑</span>';
                            } else if (diff < -1) {
                                trend = '<span class="trend-indicator trend-down">↓</span>';
                            }
                        }
                    }
                }
                
                return `
                    <li class="pathogen-item ${isHighRisk ? 'high-risk' : ''}">
                        <div>
                            <div class="pathogen-name">#${index + 1} ${pathogen.nombre || 'Desconocido'}</div>
                        </div>
                        <div>
                            <span class="pathogen-percentage">${typeof pathogen.porcentaje === 'number' ? pathogen.porcentaje.toFixed(1) : '0.0'}%</span>
                            ${trend}
                        </div>
                    </li>
                `;
            }).join('');
            
            document.getElementById('pathogenList').innerHTML = `<ul class="pathogen-list">${listHTML}</ul>`;
        }

        function showError(message) {
            console.error('Error mostrado al usuario:', message);
            const alertBanner = document.getElementById('alertBanner');
            const alertMessage = document.getElementById('alertMessage');
            if (alertBanner && alertMessage) {
                alertBanner.style.display = 'flex';
                alertBanner.className = 'alert-banner critical';
                alertMessage.textContent = message;
            }
        }
        
        function showAlternativeChart(canvasId, message) {
            const canvas = document.getElementById(canvasId);
            if (canvas && canvas.parentElement) {
                if (canvasId === 'mainChart' && data.length > 0) {
                    // Mostrar barras simples con CSS para el gráfico principal
                    const latestWeeks = data.slice(-5);
                    const latestWeek = data[data.length - 1];
                    const top5 = latestWeek.patogenos.slice(0, 5);
                    
                    let barsHTML = '<div style="padding: 20px;"><h3 style="margin-bottom: 20px; color: #2c3e50;">Top 5 Patógenos - Última Semana</h3>';
                    
                    top5.forEach((pathogen, i) => {
                        const colors = ['#0066cc', '#28a745', '#ffc107', '#dc3545', '#6c757d'];
                        const percentage = pathogen.porcentaje || 0;
                        barsHTML += `
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="font-weight: 600;">${pathogen.nombre}</span>
                                    <span style="font-weight: 700; color: ${colors[i]};">${percentage.toFixed(1)}%</span>
                                </div>
                                <div style="background: #e9ecef; height: 30px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: ${colors[i]}; height: 100%; width: ${percentage}%; transition: width 0.5s ease;"></div>
                                </div>
                            </div>
                        `;
                    });
                    
                    barsHTML += '</div>';
                    canvas.parentElement.innerHTML = barsHTML;
                } else {
                    canvas.parentElement.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #6c757d;">
                            <p>${message}</p>
                        </div>
                    `;
                }
            }
        }

        // Ejecutar inicialización después de un breve delay
        setTimeout(() => {
            console.log('Iniciando dashboard (con o sin Chart.js)...');
            initializeDashboard();
        }, 2000);
        
        function initializeDashboard() {
            console.log('Inicializando dashboard...');
            
            // Configurar Chart.js si está disponible
            if (typeof Chart !== 'undefined') {
                Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
                Chart.defaults.color = '#2c3e50';
            }
            
            // Intentar cargar datos con fetch normal
            fetchData().catch(error => {
                console.error('Fetch falló, intentando con JSONP...', error);
                // Si fetch falla, intentar con JSONP
                fetchDataJSONP();
            });
            
            // Auto-refresh every 5 minutes
            setInterval(() => {
                fetchData().catch(() => fetchDataJSONP());
            }, 300000);
        }
        
        // Global error handler
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Error global:', msg, 'en línea:', lineNo);
            return false;
        };
        
        // Función alternativa con JSONP para evitar CORS
        function fetchDataJSONP() {
            console.log('Intentando con JSONP...');
            
            // Crear callback único
            const callbackName = 'dashboardCallback_' + Date.now();
            
            // Definir callback global
            window[callbackName] = function(result) {
                console.log('Datos recibidos via JSONP');
                
                if (result.exito && result.datos && Array.isArray(result.datos) && result.datos.length > 0) {
                    // Eliminar duplicados basándose en la fecha
                    const uniqueDates = new Map();
                    result.datos.forEach(week => {
                        if (week && week.fecha) {
                            const dateStr = new Date(week.fecha).toISOString().split('T')[0];
                            if (!uniqueDates.has(dateStr)) {
                                uniqueDates.set(dateStr, week);
                            }
                        }
                    });
                    
                    data = Array.from(uniqueDates.values()).sort((a, b) => 
                        new Date(a.fecha) - new Date(b.fecha)
                    );
                    
                    console.log(`Datos cargados: ${result.totalSemanas} total, ${data.length} únicas`);
                    
                    document.getElementById('totalWeeks').textContent = data.length;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('es-CO');
                    
                    processData();
                    
                    if (typeof Chart !== 'undefined') {
                        createMainChart();
                        createTrendChart();
                    } else {
                        showAlternativeChart('mainChart', 'Visualización de datos');
                        showAlternativeChart('trendChart', 'Tendencias');
                    }
                    
                    updatePathogenList();
                } else {
                    showError('No se encontraron datos válidos');
                }
                
                // Limpiar
                delete window[callbackName];
                document.head.removeChild(script);
            };
            
            // Crear script tag
            const script = document.createElement('script');
            script.src = WEB_APP_URL + '?callback=' + callbackName;
            script.onerror = () => {
                console.error('Error al cargar JSONP');
                showError('Error de conexión. Verifica la configuración del Web App.');
                delete window[callbackName];
            };
            
            document.head.appendChild(script);
        }
    </script>
</body>
</html>
